package com.droidz.homemanager;

import java.util.ArrayList;
import java.util.List;

import android.app.Activity;
import android.app.AlertDialog;
import android.content.ComponentName;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.content.pm.PackageManager.NameNotFoundException;
import android.content.pm.ResolveInfo;
import android.graphics.drawable.Drawable;
import android.os.Bundle;
import android.widget.ListView;

import com.droidz.homemanager.R;

public class HomeManager_List extends Activity {
	private boolean defaultFound = false;
	private List<ComponentName> activities;
	private List<ResolveInfo> resolveInfoList;
	private PackageManager packageManager;
	
	private void getDefaultActivities() {
		IntentFilter intentFilter = new IntentFilter();
		intentFilter.addAction(Intent.ACTION_MAIN);
		intentFilter.addCategory(Intent.CATEGORY_HOME);
		
		List<IntentFilter> intentFilterList = new ArrayList<IntentFilter>();
		intentFilterList.add(intentFilter);
		
		activities = new ArrayList<ComponentName>();
		
		packageManager.getPreferredActivities(intentFilterList, activities, null);
	}
	
	private boolean isDefault(String packageName) {
		for(int i = 1; i < activities.size(); i++) {
			if(activities.get(i).getPackageName().equals(packageName)) {
				defaultFound = true;
				return true;
			}	
		}
		return false;
	}
	
	private boolean isSystemApp(String packageName) {
		ApplicationInfo appInfo = null;
		
		try {
			appInfo = packageManager.getApplicationInfo(packageName, 0);
		} catch (NameNotFoundException e) {
			e.printStackTrace();
		}
		
		if((appInfo.flags & (ApplicationInfo.FLAG_SYSTEM | ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != 0)
			return true;
		
		return false;
	}
	
	private List<Launcher> getLaunchers() {
		List<Launcher> launchers = new ArrayList<Launcher>();
		
		Intent intent = new Intent(Intent.ACTION_MAIN);
		intent.addCategory(Intent.CATEGORY_HOME);
		
		resolveInfoList = packageManager.queryIntentActivities(intent, 0);
		
		getDefaultActivities();
		
		for(int i = 0; i < resolveInfoList.size(); i++) {
			ResolveInfo resolveInfo = resolveInfoList.get(i);
		
			String packageName = resolveInfo.activityInfo.packageName;
			String name = resolveInfo.loadLabel(packageManager).toString();
			Drawable icon = resolveInfo.loadIcon(packageManager);
		
			if(!defaultFound)
				launchers.add(new Launcher(packageName, isDefault(packageName), icon, name, isSystemApp(packageName)));
			else
				launchers.add(new Launcher(packageName, false, icon, name, isSystemApp(packageName)));
		}
		return launchers;
	}
	
	private void showGetMoreLaunchersDialog() {
		AlertDialog.Builder builder = new AlertDialog.Builder(this);
		builder.setMessage(R.string.get_more_launchers);
		builder.setPositiveButton("Ok", 
				new DialogInterface.OnClickListener() {

					@Override
					public void onClick(DialogInterface dialog, int which) {
						
					}
		});		
		
		AlertDialog alertDialog = builder.create();
		alertDialog.show();
	}
    
    @Override
    protected void onStart() {
    	super.onStart();
    	packageManager = getPackageManager();
    	
	    HomeManagerListAdapter adapter = new HomeManagerListAdapter(this,
	        	R.layout.row, getLaunchers());
	        
	    ListView listView = (ListView)findViewById(R.id.homemanager_list);
	    listView.setAdapter(adapter);
	    
	    if(resolveInfoList.size() > 1) {
		    if(!defaultFound) {
		    	Intent launchHome = new Intent(Intent.ACTION_MAIN);
		    	launchHome.addCategory(Intent.CATEGORY_HOME);
		    	
		    	startActivity(launchHome);
		    }
	    }
	    else
	    	showGetMoreLaunchersDialog();
	    
    	defaultFound = false;
    }
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        setContentView(R.layout.activity_home_manager__list);
    }
}
